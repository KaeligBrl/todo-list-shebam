{% extends 'base.html.twig' %}

{% block content %}
    <title>{%  block title %}Semaine Actuelle - {% block title_base %}{{ parent() }}{% endblock %}{% endblock %}</title>
	<div class="mb-5">
		<img class="d-block mx-auto" src="{{ asset('/assets/images/todo.png') }}" alt="Logo de connexion To Do List">
		<h1 class="text-center color-white mb-3">Semaine Actuelle</h1>
		<div class="mb-5"></div>
		<div class="container">
			<div class="tabs">
				<button data-content="1" class="tab-button" onclick="deactivateText(this)">priorité n°2</button>
				<button data-content="2" class="tab-button" onclick="deactivateText(this)">rendez-vous</button>
				<button data-content="3" class="tab-button" onclick="deactivateText(this)">devis</button>
			</div>
			<div class="content">
				<div class="tabstable mt-5">
					{% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}
						<div class="mb-4">
							<a class="color-yellow text-20 text-bold" href="#ajouterunetachep2"><i class="fas fa-plus-circle"></i>&nbsp; Ajouter une tâche</a>
						</div>
					{% endif %}
					<table id="tableOrderTaskP1" class="table mb-5 table-bordered" data-toggle="table" {% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%} data-use-row-attr-func="true" data-reorderable-rows="true" {% endif %}>
						<thead class="bg-blue-dark-light table-borderless">
							<tr style="border-right-style: none;">
								<th class="color-yellow text-bold" data-field="id" data-visible="false">ID</th>
								<th class="color-yellow text-bold" data-field="customer"{% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}data-sortable="true"{% endif %} scope="col">Client</th>
								<th class="color-yellow text-bold" data-field="subject" {% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}data-sortable="true"{% endif %} scope="col">Sujet</th>
								<th class="color-yellow text-bold" data-field="person" {% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}data-sortable="true"{% endif %} scope="col">Équipe</th>
								{% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}
									<th class="color-yellow text-bold" scope="col">Action</th>
									<th class="color-yellow text-bold" scope="col">Fait</th>
								{% endif %}
							</tr>
						</thead>
						<tbody class="bg-blue-dark">
							{% for task in task %}
								{% if task.p2 == 1 and task.p1 == 0 and task.nextweek == 0 %}
									{% if task.done == 0 %}
										<tr class="">
											<td>{{ task.id }}</td>
											<td class="color-white text-bold">{{task.customer}}</td>
											<td class="color-white text-bold">
												{% if task.object is empty %}{% else %}{{task.object}}<br>{% endif %}
												{% if task.subobject1 is empty %}{% else %}{{task.subobject1}}<br>{% endif %} 
												{% if task.subobject1 is empty %}{% else %}{{task.subobject2}}<br>{% endif %}
												{% if task.subobject1 is empty %}{% else %}{{task.subobject3}}{% endif %}
											</td>
											<td class="color-white text-bold">{% for task in task.users %}
													{{ task.firstname }} <br>
												{% endfor %}
											</td>
										{% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}
											<td>
												<a class="color-yellow text-bold" href="{{ path('task_cw_change_to_p1_front', {"id": task.id}) }}"><span>P1</span></a>&nbsp;
												
												<a class="color-yellow" href="{{ path('task_change_p2_cw_to_p2_nw_front', {"id": task.id}) }}"><i class="fas fa-redo"></i>&nbsp;</a>
													
												<a class="color-yellow" href="{{ path('modify_task_p2_cw', {"id": task.id}) }}"><i class="fas fa-cog"></i></a>&nbsp;
													
												<a class="color-yellow" href="{{ path('delete_task_cw_front', {"id": task.id}) }}" onclick="return confirm('Attention vous vous apprettez à supprimer une tâche P1')"><i class="fas fa-trash"></i></a>
											</td>
												<td class="form-switch">											
													<input type="checkbox" class="taskdone" {{ (task.done) ? 'checked' : ''}} data-taskdone="{{task.id}}">
												</td>
										{% endif %}
										</tr>
									{% else %}
										<tr class="bg-yellow">
											<td>{{ task.id }}</td>
											<td class="color-blue-dark text-bold">{{task.customer}}</td>
											<td class="color-blue-dark text-bold">
												{% if task.object is empty %}{% else %}{{task.object}}<br>{% endif %}
												{% if task.subobject1 is empty %}{% else %}{{task.subobject1}}<br>{% endif %} 
												{% if task.subobject1 is empty %}{% else %}{{task.subobject2}}<br>{% endif %}
												{% if task.subobject1 is empty %}{% else %}{{task.subobject3}}{% endif %}
											</td>
											<td class="color-blue-dark text-bold">{% for task in task.users %}
													{{ task.firstname }} <br>
												{% endfor %}
											</td>
										{% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}
											<td>
												<a class="color-blue-dark text-bold" href="{{ path('task_cw_change_to_p1_front', {"id": task.id}) }}"><span>P1</span></a>&nbsp;
												
												<a class="color-blue-dark" href="{{ path('task_change_p2_cw_to_p2_nw_front', {"id": task.id}) }}"><i class="fas fa-redo"></i>&nbsp;</a>
													
												<a class="color-blue-dark" href="{{ path('modify_task_p2_cw', {"id": task.id}) }}"><i class="fas fa-cog"></i></a>&nbsp;
													
												<a class="color-blue-dark" href="{{ path('delete_task_cw_front', {"id": task.id}) }}" onclick="return confirm('Attention vous vous apprettez à supprimer une tâche P1')"><i class="fas fa-trash"></i></a>
											</td>
												<td class="oui form-switch">											
													<input type="checkbox" class="taskdone" {{ (task.done) ? 'checked' : ''}} data-taskdone="{{task.id}}">
												</td>
										{% endif %}
										</tr>
									{% endif %}
								{% endif %}
							{% endfor %}
						</tbody>
					</table>
				</div>
				<div class="tabstable mt-5">
					{% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}
						<div class="mb-4">
							<a class="color-yellow text-20 text-bold" href="#ajouterunrendezvous"><i class="fas fa-plus-circle"></i>&nbsp; Ajouter un rendez-vous</a>
						</div>
					{% endif %}
					<table id="tableOrderAppointment" class="table table-bordered" data-toggle="table">
						<thead class="bg-blue-dark-light table-borderless">
							<tr>
								<th data-field="id" data-visible="false">ID</th>
								<th class="color-yellow text-bold" scope="col">Date et heure</th>
								<th class="color-yellow text-bold" scope="col">Client</th>
								<th class="color-yellow text-bold" scope="col">Objet</th>
								<th class="color-yellow text-bold" scope="col"></th>
								
							{% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}
								<th class="color-yellow text-bold" scope="col">Action</th>
							{% endif %}
							</tr>
						</thead>
						<tbody class="bg-blue-dark">
							{% for appointment in appointment %}
								{% if appointment.nextweek == 0 %}					
									<tr class="bg-white-shebam">
										<td class="color-white text-bold">{{appointment.id}}</td>
										<td class="color-white text-bold">{{ appointment.hoursappointment|date("d-m-Y")  }} à {{appointment.hoursappointment|date('H:i')}}</td>
										<td class="color-white text-bold">{{appointment.name}}</td>
										<td class="color-white text-bold">{{appointment.subject}}</td>
										<td class="color-white text-bold">
										{% for appointment in appointment.user %}
											{{ appointment.firstname }} <br>
										{% endfor %}
										</td>
										{% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}
										<td class="color-yellow">
												
											<a class="color-yellow" href="{{ path('change_appointment_cw_to_nw_front', {"id": appointment.id}) }}"><i class="fas fa-redo"></i></a>&nbsp;
												
											<a class="color-yellow" href="{{ path('modify_appointment_cw', {"id": appointment.id}) }}"><i class="fas fa-cog"></i></a>&nbsp;

											<a class="color-yellow" href="{{ path('delete_appointment_cw_front', {"id": appointment.id}) }}" onclick="return confirm('Attention vous vous apprettez à supprimer un rendez-vous')"><i class="fas fa-trash"></i></a>
										</td>
									{% endif %}
									</tr>
								{% endif %}
							{% endfor %}
						</tbody>
					</table>
				</div>
				<div class="tabstable mt-5">
					{% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}
						<div class="mb-4">
							<p class="color-yellow text-20 text-bold"><a class="btn-blue-light-shebam" href="#ajouterundevis">&nbsp;<i class="fas fa-plus-circle"></i>&nbsp;Ajouter un devis</a></p>
						</div>
					{% endif %}
					<table id="tableOrderQuote" class="table" data-toggle="table">
						<thead class="bg-blue-dark-light table-borderless">
							<tr>
								<th class="color-yellow text-bold" data-field="id" data-visible="false">ID</th>
								<th class="color-yellow text-bold" scope="col">Sujet</th>
								<th class="color-yellow text-bold" scope="col">Objet</th>
								<th class="color-yellow text-bold" scope="col">Personne(s)</th>
							{% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}
								<th class="color-yellow text-bold" scope="col">Action</th>
							{% endif %}
							</tr>
						</thead>
						<tbody class="bg-blue-dark">
							{% for quote in quote %}
								{% if quote.nextweek == 0 %}	
									<tr class="bg-white-shebam">
										<td class="color-white text-bold">{{ quote.id }}</td>
										<td class="color-white text-bold">{{ quote.subject }}</td>
										<td class="color-white text-bold">{{ quote.object }}</td>
										<td class="color-white text-bold">
										{% for quote in quote.person %}
											{{ quote.firstname }} <br>
										{% endfor %}
										</td>
									{% if is_granted('IS_AUTHENTICATED_FULLY') and is_granted('ROLE_ADMIN')%}
										<td>
											<a  class="color-yellow" href="{{ path('change_quote_cw_to_nw_front', {"id": quote.id}) }}"><i class="fas fa-redo"></i></a>
											&nbsp;
											<a class="color-yellow" href="{{ path('modify_quote_cw', {"id": quote.id}) }}"><i class="fas fa-cog"></i></a>
											&nbsp;
											<a  class="color-yellow" href="{{ path('delete_quote_cw_front', {"id": quote.id}) }}" onclick="return confirm('Attention vous vous apprettez à supprimer un devis')"><i class="fas fa-trash"></i></a>
										</td>
									{% endif %}
									</tr>
								{% endif %}
							{% endfor %}
						</tbody>
					</table>	
				</div>
				{% if app.user.email == 'kaelig@shebam.fr' %}
					{% if task is empty and quote is empty and appointment is empty %}
						<div style="pointer-events: none" class="mt-3 text-center color-yellow"><span>Il faut au moins une donnée pour faire le basculement</span></div>
					{% else %}			
						<div class="mt-3 text-center btn-yellow btn"><a href="{{ path('mission_nw_change_to_cw_front') }}">Basculer vers la semaine suivante</a></div>
					{% endif %}
				{% endif %}
			</div>
		</div>

		<!-- POPUP -->

		<!-- Task P2 -->
		<div id="ajouterunetachep2" class=" overlay">
			<div class="popup bg-blue-dark-light">
				<a class="close" href=""><i class="fas fa-times"></i></a>
					<div class="content">
					{{ form_start(form_task_p2_cw_add_front) }}
							<div class="form-group">
								<div class="input">{{ form_row(form_task_p2_cw_add_front.customer) }}</div>
								{{ form_row(form_task_p2_cw_add_front.object) }}
								{{ form_row(form_task_p2_cw_add_front.subobject1) }}
								{{ form_row(form_task_p2_cw_add_front.subobject2) }}
								{{ form_row(form_task_p2_cw_add_front.subobject3) }}
								<p class="text-left color-yellow text-bold">Personne(s)</p>
								<div class="bg-blue-dark text-left users">
									{{ form_row(form_task_p2_cw_add_front.users) }}
								</div>
								<div class="text-left mt-3 color-yellow">
									{{ form_row(form_task_p2_cw_add_front.p2) }}
								</div>
							
								{{ form_row(form_task_p2_cw_add_front.submit) }}
							
						</div>
					{{ form_end(form_task_p2_cw_add_front) }}
				</div>
			</div>
		</div>

		<!-- Appointment -->
		<div id="ajouterunrendezvous" class="overlay">
			<div class="popup bg-blue-dark-light">
			<a class="close" href=""><i class="fas fa-times"></i></a>
				<div class="content">
					{{ form_start(form_appointment_cw_add_front) }}
							<div class="form-group">
								{{ form_row(form_appointment_cw_add_front.name) }}
								{{ form_row(form_appointment_cw_add_front.subject) }}
								<div class="text-bold color-yellow text-left">
									{{ form_row(form_appointment_cw_add_front.hoursappointment) }}
								</div>
								<p class="text-left color-yellow text-bold">Personne(s)</p>
								<div class="bg-black-light text-left users mb-3">
									{{ form_row(form_appointment_cw_add_front.user) }}
								</div>
							</div>
							<div class="form-group">
								{{ form_row(form_appointment_cw_add_front.submit) }}
							</div>
					{{ form_end(form_appointment_cw_add_front) }}
				</div>
			</div>
		</div>

		<!-- Quote -->
		<div id="ajouterundevis" class="overlay">
			<div class="popup bg-blue-dark-light">
			<a class="close" href=""><i class="fas fa-times"></i></a>
				<div class="content">
					{{ form_start(form_quote_cw_add_front) }}
							<div class="form-group">
								{{ form_row(form_quote_cw_add_front.subject) }}
								{{ form_row(form_quote_cw_add_front.object) }}
								<p class="text-left color-yellow text-bold">Personne(s)</p>
								<div class="bg-blue-dark text-left users">
									{{ form_row(form_quote_cw_add_front.person) }}
								</div>
							</div>
							<div class="form-group">
								{{ form_row(form_quote_cw_add_front.submit) }}
							</div>
					{{ form_end(form_quote_cw_add_front) }}
				</div>
			</div>
		</div>
	</div>
{%  endblock %}
{% block javascripts %}
	{{ parent() }}
	<script>
		$(()=>{
			$("#tableOrderTaskP1").on("reorder-row.bs.table", (e, table, row, old) => {
				$.ajax({
					url: "{{ path('home_cw_reorder_row')}}",
					method: "POST",
					data: {
						table: JSON.stringify(table),
						context: 1
					},
					dataType: "JSON"
				})
			})
			$("#tableOrderTaskP2").on("reorder-row.bs.table", (e, table, row, old) => {
				$.ajax({
					url: "{{ path('home_cw_reorder_row')}}",
					method: "POST",
					data: {
						table: JSON.stringify(table),
						context: 1
					},
					dataType: "JSON"
				})
			})
			$("#tableOrderAppointment").on("reorder-row.bs.table", (e, table, row, old) => {
				$.ajax({
					url: "{{ path('home_cw_reorder_row')}}",
					method: "POST",
					data: {
						table: JSON.stringify(table),
						context: 2
					},
					dataType: "JSON"
				})
			})
			$("#tableOrderQuote").on("reorder-row.bs.table", (e, table, row, old) => {
				$.ajax({
					url: "{{ path('home_cw_reorder_row')}}",
					method: "POST",
					data: {
						table: JSON.stringify(table),
						context: 3
					},
					dataType: "JSON"
				})
			})
		})
	</script>
{% endblock %}